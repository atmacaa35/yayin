<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>PeerJS ile Ekran Yayını</title>
  <style>
    body { background: #000; color: #fff; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    video { width: 90%; max-width: 800px; margin-top: 20px; border: 2px solid lime; background-color: #222; }
    button, input { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: #fff; font-size: 16px; }
    button:hover:not(:disabled) { background-color: #444; cursor: pointer;}
    button:disabled { background-color: #2a2a2a; color: #666; cursor: not-allowed;}
    input { background-color: #111; border-color: #444; }
    #my-id-container { margin-bottom: 15px; font-size: 18px; }
    #controls { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>PeerJS ile Ekran Yayını</h1>
  
  <div id="my-id-container">
    Benim ID'm: <span id="my-id" style="font-weight: bold; color: lime;">Yükleniyor...</span>
  </div>

  <div id="controls">
    <button id="start">🖥️ Yayını Başlat</button>
    <input type="text" id="target-id" placeholder="Yayıncı ID'sini girin">
    <button id="watch">📺 İzle</button>
  </div>

  <video id="video" autoplay playsinline controls muted></video>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const videoElement = document.getElementById('video');
    const myIdSpan = document.getElementById('my-id');
    const startButton = document.getElementById('start');
    const watchButton = document.getElementById('watch');
    const targetIdInput = document.getElementById('target-id');

    let localStream = null; // Yerel medya akışını (ekran görüntüsü + ses) tutar
    let peer = null;        // PeerJS nesnesi
    let currentCall = null; // Mevcut aktif çağrıyı (izleyici için) tutar

    // PeerJS Sunucu Bilgileri (Kendi sunucunuzu veya test sunucusunu kullanabilirsiniz)
    const peerJsConfig = {
      host: 'peercik.onrender.com', 
      port: 443,
      path: '/myapp',
      secure: true,
      // debug: 3 // Hata ayıklama seviyesi (0: kapalı, 1: hatalar, 2: uyarılar, 3: tüm loglar)
    };

    function initializePeer() {
      // Yeni bir Peer nesnesi oluşturulur. ID sunucu tarafından atanır (ilk argüman undefined).
      peer = new Peer(undefined, peerJsConfig);

      // PeerJS bağlantısı başarıyla açıldığında tetiklenir.
      peer.on('open', id => {
        myIdSpan.textContent = id;
        console.log('PeerJS bağlantısı açıldı. Benim ID:', id);
        startButton.disabled = false;
        watchButton.disabled = false;
        targetIdInput.disabled = false;
      });

      // Başka bir peer'den çağrı geldiğinde tetiklenir.
      peer.on('call', incomingCall => {
        console.log('Gelen çağrı:', incomingCall.peer);
        if (localStream) {
          // Eğer bir yayın yapılıyorsa (localStream mevcutsa), gelen çağrıyı yanıtla.
          console.log(`${incomingCall.peer} adlı kullanıcıya yayınla cevap veriliyor.`);
          incomingCall.answer(localStream); 
          
          // Gelen çağrı için olay dinleyicileri
          incomingCall.on('close', () => {
            console.log(`İzleyici ${incomingCall.peer} bağlantısı kapandı.`);
          });
          incomingCall.on('error', err => {
            console.error(`Gelen çağrıda (${incomingCall.peer}) hata:`, err);
          });
        } else {
          console.warn('Gelen çağrı var ancak yerel yayın (localStream) mevcut değil. Çağrı yoksayılıyor.');
          // İsteğe bağlı: incomingCall.close(); // Çağrıyı reddetmek için
        }
      });

      // PeerJS genel hata durumlarında tetiklenir.
      peer.on('error', err => {
        console.error('PeerJS Hatası:', err);
        myIdSpan.textContent = "Bağlantı Hatası!";
        alert(`PeerJS Bağlantı Hatası: ${err.message}\n\nLütfen sayfayı yenileyin veya PeerJS sunucu ayarlarını kontrol edin.`);
        disableControlsOnError();
        if (err.type === 'peer-unavailable') {
            alert('Aranan kullanıcı IDsi bulunamadı veya çevrimdışı.');
        } else if (err.type === 'network') {
            alert('Ağ hatası. İnternet bağlantınızı veya PeerJS sunucusuna erişimi kontrol edin.');
        } else if (err.type === 'server-error') {
            alert('PeerJS sunucusunda bir hata oluştu.');
        }
      });

      // PeerJS sunucusuyla bağlantı kesildiğinde tetiklenir.
      peer.on('disconnected', () => {
        console.warn('PeerJS sunucusuyla bağlantı kesildi. Yeniden bağlanmaya çalışılıyor...');
        myIdSpan.textContent = "Bağlantı kesildi...";
        // PeerJS genellikle otomatik olarak yeniden bağlanmayı dener.
        // Butonları geçici olarak devre dışı bırakmak iyi bir pratik olabilir.
      });

      // Peer bağlantısı tamamen kapatıldığında (destroy edildiğinde) tetiklenir.
      peer.on('close', () => {
        console.log('Peer bağlantısı tamamen kapandı.');
        myIdSpan.textContent = "Kapalı";
        disableControlsOnError();
      });
    }

    function disableControlsOnError() {
        startButton.disabled = true;
        watchButton.disabled = true;
        targetIdInput.disabled = true;
    }

    // Başlangıçta butonlar PeerJS bağlanana kadar devre dışı bırakılır.
    startButton.disabled = true; 
    watchButton.disabled = true;
    targetIdInput.disabled = true;

    // "Yayını Başlat" butonu tıklama olayı
    startButton.onclick = async () => {
      if (localStream) { // Eğer zaten yayın yapılıyorsa, bu buton "Yayını Durdur" işlevindedir.
        stopBroadcast();
        return;
      }

      try {
        console.log('Ekran yayını başlatılıyor...');
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            width: { ideal: 1920, max: 1920 },
            height: { ideal: 1080, max: 1080 },
            frameRate: { ideal: 30, max: 60 } 
          },
          audio: { // Ekran sesi paylaşımı için (tarayıcı ve OS desteğine bağlı)
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        videoElement.srcObject = localStream;
        videoElement.play().catch(e => console.warn("Yerel video oynatma hatası (otomatik oynatma engellenmiş olabilir):", e));
        console.log('Ekran yakalama başarılı. Yayın başladı.');
        
        startButton.textContent = "Yayını Durdur";
        watchButton.disabled = true;  // Yayın yaparken izleme butonunu devre dışı bırak
        targetIdInput.disabled = true;

        // Kullanıcı tarayıcı arayüzünden ekran paylaşımını durdurursa
        localStream.getVideoTracks()[0].onended = () => {
            console.log("Ekran paylaşımı kullanıcı tarafından veya bir nedenle sonlandırıldı.");
            stopBroadcast();
        };

      } catch (err) {
        console.error('Ekran yakalama veya yayın başlatma hatası:', err);
        alert(`Ekran yakalama başlatılamadı: ${err.name} - ${err.message}`);
        localStream = null; 
      }
    };

    function stopBroadcast() {
        console.log("Yayın durduruluyor...");
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop()); // Tüm medya izlerini durdur
            localStream = null;
        }
        videoElement.srcObject = null; // Video elementini temizle
        
        startButton.textContent = "🖥️ Yayını Başlat";
        // PeerJS hala bağlıysa izleme kontrollerini tekrar aktif et
        if (peer && !peer.disconnected && !peer.destroyed) {
            watchButton.disabled = false;
            targetIdInput.disabled = false;
        }
        console.log("Yayın durduruldu.");
    }

    // "İzle" butonu tıklama olayı
    watchButton.onclick = () => {
      if (currentCall) { // Zaten bir yayın izleniyorsa, tekrar basıldığında bağlantıyı kes
          console.log("Mevcut yayın sonlandırılıyor...");
          currentCall.close(); // Bu, 'close' olayını tetikleyecektir.
          // currentCall ve UI resetleme 'close' handler'ında yapılacak.
          return;
      }

      const targetId = targetIdInput.value.trim();
      if (!targetId) {
        alert("Lütfen bir Yayıncı ID'si girin.");
        return;
      }

      if (!peer || peer.disconnected || peer.destroyed) {
        alert("PeerJS bağlantısı aktif değil. Lütfen sayfayı yenileyin veya bağlantının kurulmasını bekleyin.");
        console.error("İzleme denemesi başarısız: PeerJS bağlantısı yok veya kopuk.");
        return;
      }
      
      if (targetId === myIdSpan.textContent) {
        alert("Kendi yayınınızı bu şekilde izleyemezsiniz. Farklı bir tarayıcı veya cihaz kullanın.");
        return;
      }

      console.log(`'${targetId}' ID'li yayıncıya bağlanılıyor...`);
      
      // Yayıncıya çağrı gönderilir. İkinci argüman 'null' çünkü biz sadece izleyiciyiz, kendi medyamızı göndermiyoruz.
      const call = peer.call(targetId, null); 
      currentCall = call; // Mevcut çağrıyı sakla

      // !!! ÖNEMLİ KONTROL !!!
      // peer.call() normalde bir MediaConnection nesnesi döndürmelidir.
      // Eğer 'undefined' dönerse, bu PeerJS'in içsel bir hatası veya ciddi bir bağlantı sorunudur.
      if (!call) {
        console.error("KRİTİK HATA: peer.call() 'undefined' döndürdü. Bu, PeerJS'in düzgün çalışmadığını gösterir. Peer nesnesi:", peer);
        alert("Yayıncıya çağrı başlatılamadı (call nesnesi oluşturulamadı).\nKonsolu kontrol edin. PeerJS bağlantınızda veya sunucuda bir sorun olabilir.");
        currentCall = null;
        return;
      }

      console.log("Çağrı nesnesi oluşturuldu. Yayıncının yanıtı ve medya akışı bekleniyor...", call);
      watchButton.textContent = "Bağlantıyı Kes";
      startButton.disabled = true; // İzleme sırasında yayın başlatmayı engelle
      targetIdInput.disabled = true;


      // Yayıncıdan medya akışı (stream) geldiğinde tetiklenir.
      call.on('stream', remoteStream => {
        console.log('Uzak yayın (stream) alındı:', remoteStream);
        videoElement.srcObject = remoteStream;
        videoElement.muted = false; // İzleyici aktif olarak izlemeye başladığı için sesi açabiliriz (tarayıcı politikalarına bağlı)
        videoElement.play().catch(e => console.warn("Uzak video oynatma hatası (otomatik oynatma engellenmiş olabilir):", e));
        alert(`'${targetId}' ID'li yayıncının yayınına bağlanıldı!`);
      });

      // Çağrı sırasında bir hata oluşursa tetiklenir.
      call.on('error', err => {
        console.error(`Çağrı sırasında hata (${call.peer}):`, err);
        alert(`Çağrı hatası: ${err.message}\n\nYayıncı ID'sinin doğru olduğundan ve yayıncının yayında olduğundan emin olun.`);
        resetWatchUI();
      });

      // Çağrı sonlandığında (yayıncı kapatırsa veya bağlantı koparsa) tetiklenir.
      call.on('close', () => {
        console.log(`Çağrı (${call.peer} ile) sonlandı/kapatıldı.`);
        alert('Yayın bağlantısı kapandı.');
        resetWatchUI();
      });
    };

    function resetWatchUI() {
        videoElement.srcObject = null;
        if (currentCall) {
            currentCall.removeAllListeners(); // Bellek sızıntılarını önlemek için tüm listener'ları kaldır
            currentCall = null;
        }
        watchButton.textContent = "📺 İzle";
        targetIdInput.disabled = false;
        // Eğer kendi yayınımızı yapmıyorsak yayın başlatma butonunu aktif et
        if (!localStream && peer && !peer.disconnected && !peer.destroyed) {
            startButton.disabled = false;
        }
    }

    // Sayfa yüklendiğinde PeerJS'i başlat
    initializePeer();

  </script>
</body>
</html>
