<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>PeerJS ile Ekran YayÄ±nÄ±</title>
  <style>
    body { background: #000; color: #fff; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    video { width: 90%; max-width: 800px; margin-top: 20px; border: 2px solid lime; background-color: #222; }
    button, input { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: #fff; font-size: 16px; }
    button:hover:not(:disabled) { background-color: #444; cursor: pointer;}
    button:disabled { background-color: #2a2a2a; color: #666; cursor: not-allowed;}
    input { background-color: #111; border-color: #444; }
    #my-id-container { margin-bottom: 15px; font-size: 18px; }
    #controls { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>PeerJS ile Ekran YayÄ±nÄ±</h1>
  
  <div id="my-id-container">
    Benim ID'm: <span id="my-id" style="font-weight: bold; color: lime;">YÃ¼kleniyor...</span>
  </div>

  <div id="controls">
    <button id="start">ğŸ–¥ï¸ YayÄ±nÄ± BaÅŸlat</button>
    <input type="text" id="target-id" placeholder="YayÄ±ncÄ± ID'sini girin">
    <button id="watch">ğŸ“º Ä°zle</button>
  </div>

  <video id="video" autoplay playsinline controls muted></video>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const videoElement = document.getElementById('video');
    const myIdSpan = document.getElementById('my-id');
    const startButton = document.getElementById('start');
    const watchButton = document.getElementById('watch');
    const targetIdInput = document.getElementById('target-id');

    let localStream = null; // Yerel medya akÄ±ÅŸÄ±nÄ± (ekran gÃ¶rÃ¼ntÃ¼sÃ¼ + ses) tutar
    let peer = null;        // PeerJS nesnesi
    let currentCall = null; // Mevcut aktif Ã§aÄŸrÄ±yÄ± (izleyici iÃ§in) tutar

    // PeerJS Sunucu Bilgileri (Kendi sunucunuzu veya test sunucusunu kullanabilirsiniz)
    const peerJsConfig = {
      host: 'peercik.onrender.com', 
      port: 443,
      path: '/myapp',
      secure: true,
      // debug: 3 // Hata ayÄ±klama seviyesi (0: kapalÄ±, 1: hatalar, 2: uyarÄ±lar, 3: tÃ¼m loglar)
    };

    function initializePeer() {
      // Yeni bir Peer nesnesi oluÅŸturulur. ID sunucu tarafÄ±ndan atanÄ±r (ilk argÃ¼man undefined).
      peer = new Peer(undefined, peerJsConfig);

      // PeerJS baÄŸlantÄ±sÄ± baÅŸarÄ±yla aÃ§Ä±ldÄ±ÄŸÄ±nda tetiklenir.
      peer.on('open', id => {
        myIdSpan.textContent = id;
        console.log('PeerJS baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±. Benim ID:', id);
        startButton.disabled = false;
        watchButton.disabled = false;
        targetIdInput.disabled = false;
      });

      // BaÅŸka bir peer'den Ã§aÄŸrÄ± geldiÄŸinde tetiklenir.
      peer.on('call', incomingCall => {
        console.log('Gelen Ã§aÄŸrÄ±:', incomingCall.peer);
        if (localStream) {
          // EÄŸer bir yayÄ±n yapÄ±lÄ±yorsa (localStream mevcutsa), gelen Ã§aÄŸrÄ±yÄ± yanÄ±tla.
          console.log(`${incomingCall.peer} adlÄ± kullanÄ±cÄ±ya yayÄ±nla cevap veriliyor.`);
          incomingCall.answer(localStream); 
          
          // Gelen Ã§aÄŸrÄ± iÃ§in olay dinleyicileri
          incomingCall.on('close', () => {
            console.log(`Ä°zleyici ${incomingCall.peer} baÄŸlantÄ±sÄ± kapandÄ±.`);
          });
          incomingCall.on('error', err => {
            console.error(`Gelen Ã§aÄŸrÄ±da (${incomingCall.peer}) hata:`, err);
          });
        } else {
          console.warn('Gelen Ã§aÄŸrÄ± var ancak yerel yayÄ±n (localStream) mevcut deÄŸil. Ã‡aÄŸrÄ± yoksayÄ±lÄ±yor.');
          // Ä°steÄŸe baÄŸlÄ±: incomingCall.close(); // Ã‡aÄŸrÄ±yÄ± reddetmek iÃ§in
        }
      });

      // PeerJS genel hata durumlarÄ±nda tetiklenir.
      peer.on('error', err => {
        console.error('PeerJS HatasÄ±:', err);
        myIdSpan.textContent = "BaÄŸlantÄ± HatasÄ±!";
        alert(`PeerJS BaÄŸlantÄ± HatasÄ±: ${err.message}\n\nLÃ¼tfen sayfayÄ± yenileyin veya PeerJS sunucu ayarlarÄ±nÄ± kontrol edin.`);
        disableControlsOnError();
        if (err.type === 'peer-unavailable') {
            alert('Aranan kullanÄ±cÄ± IDsi bulunamadÄ± veya Ã§evrimdÄ±ÅŸÄ±.');
        } else if (err.type === 'network') {
            alert('AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± veya PeerJS sunucusuna eriÅŸimi kontrol edin.');
        } else if (err.type === 'server-error') {
            alert('PeerJS sunucusunda bir hata oluÅŸtu.');
        }
      });

      // PeerJS sunucusuyla baÄŸlantÄ± kesildiÄŸinde tetiklenir.
      peer.on('disconnected', () => {
        console.warn('PeerJS sunucusuyla baÄŸlantÄ± kesildi. Yeniden baÄŸlanmaya Ã§alÄ±ÅŸÄ±lÄ±yor...');
        myIdSpan.textContent = "BaÄŸlantÄ± kesildi...";
        // PeerJS genellikle otomatik olarak yeniden baÄŸlanmayÄ± dener.
        // ButonlarÄ± geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rakmak iyi bir pratik olabilir.
      });

      // Peer baÄŸlantÄ±sÄ± tamamen kapatÄ±ldÄ±ÄŸÄ±nda (destroy edildiÄŸinde) tetiklenir.
      peer.on('close', () => {
        console.log('Peer baÄŸlantÄ±sÄ± tamamen kapandÄ±.');
        myIdSpan.textContent = "KapalÄ±";
        disableControlsOnError();
      });
    }

    function disableControlsOnError() {
        startButton.disabled = true;
        watchButton.disabled = true;
        targetIdInput.disabled = true;
    }

    // BaÅŸlangÄ±Ã§ta butonlar PeerJS baÄŸlanana kadar devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±r.
    startButton.disabled = true; 
    watchButton.disabled = true;
    targetIdInput.disabled = true;

    // "YayÄ±nÄ± BaÅŸlat" butonu tÄ±klama olayÄ±
    startButton.onclick = async () => {
      if (localStream) { // EÄŸer zaten yayÄ±n yapÄ±lÄ±yorsa, bu buton "YayÄ±nÄ± Durdur" iÅŸlevindedir.
        stopBroadcast();
        return;
      }

      try {
        console.log('Ekran yayÄ±nÄ± baÅŸlatÄ±lÄ±yor...');
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: {
            width: { ideal: 1920, max: 1920 },
            height: { ideal: 1080, max: 1080 },
            frameRate: { ideal: 30, max: 60 } 
          },
          audio: { // Ekran sesi paylaÅŸÄ±mÄ± iÃ§in (tarayÄ±cÄ± ve OS desteÄŸine baÄŸlÄ±)
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        videoElement.srcObject = localStream;
        videoElement.play().catch(e => console.warn("Yerel video oynatma hatasÄ± (otomatik oynatma engellenmiÅŸ olabilir):", e));
        console.log('Ekran yakalama baÅŸarÄ±lÄ±. YayÄ±n baÅŸladÄ±.');
        
        startButton.textContent = "YayÄ±nÄ± Durdur";
        watchButton.disabled = true;  // YayÄ±n yaparken izleme butonunu devre dÄ±ÅŸÄ± bÄ±rak
        targetIdInput.disabled = true;

        // KullanÄ±cÄ± tarayÄ±cÄ± arayÃ¼zÃ¼nden ekran paylaÅŸÄ±mÄ±nÄ± durdurursa
        localStream.getVideoTracks()[0].onended = () => {
            console.log("Ekran paylaÅŸÄ±mÄ± kullanÄ±cÄ± tarafÄ±ndan veya bir nedenle sonlandÄ±rÄ±ldÄ±.");
            stopBroadcast();
        };

      } catch (err) {
        console.error('Ekran yakalama veya yayÄ±n baÅŸlatma hatasÄ±:', err);
        alert(`Ekran yakalama baÅŸlatÄ±lamadÄ±: ${err.name} - ${err.message}`);
        localStream = null; 
      }
    };

    function stopBroadcast() {
        console.log("YayÄ±n durduruluyor...");
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop()); // TÃ¼m medya izlerini durdur
            localStream = null;
        }
        videoElement.srcObject = null; // Video elementini temizle
        
        startButton.textContent = "ğŸ–¥ï¸ YayÄ±nÄ± BaÅŸlat";
        // PeerJS hala baÄŸlÄ±ysa izleme kontrollerini tekrar aktif et
        if (peer && !peer.disconnected && !peer.destroyed) {
            watchButton.disabled = false;
            targetIdInput.disabled = false;
        }
        console.log("YayÄ±n durduruldu.");
    }

    // "Ä°zle" butonu tÄ±klama olayÄ±
    watchButton.onclick = () => {
      if (currentCall) { // Zaten bir yayÄ±n izleniyorsa, tekrar basÄ±ldÄ±ÄŸÄ±nda baÄŸlantÄ±yÄ± kes
          console.log("Mevcut yayÄ±n sonlandÄ±rÄ±lÄ±yor...");
          currentCall.close(); // Bu, 'close' olayÄ±nÄ± tetikleyecektir.
          // currentCall ve UI resetleme 'close' handler'Ä±nda yapÄ±lacak.
          return;
      }

      const targetId = targetIdInput.value.trim();
      if (!targetId) {
        alert("LÃ¼tfen bir YayÄ±ncÄ± ID'si girin.");
        return;
      }

      if (!peer || peer.disconnected || peer.destroyed) {
        alert("PeerJS baÄŸlantÄ±sÄ± aktif deÄŸil. LÃ¼tfen sayfayÄ± yenileyin veya baÄŸlantÄ±nÄ±n kurulmasÄ±nÄ± bekleyin.");
        console.error("Ä°zleme denemesi baÅŸarÄ±sÄ±z: PeerJS baÄŸlantÄ±sÄ± yok veya kopuk.");
        return;
      }
      
      if (targetId === myIdSpan.textContent) {
        alert("Kendi yayÄ±nÄ±nÄ±zÄ± bu ÅŸekilde izleyemezsiniz. FarklÄ± bir tarayÄ±cÄ± veya cihaz kullanÄ±n.");
        return;
      }

      console.log(`'${targetId}' ID'li yayÄ±ncÄ±ya baÄŸlanÄ±lÄ±yor...`);
      
      // YayÄ±ncÄ±ya Ã§aÄŸrÄ± gÃ¶nderilir. Ä°kinci argÃ¼man 'null' Ã§Ã¼nkÃ¼ biz sadece izleyiciyiz, kendi medyamÄ±zÄ± gÃ¶ndermiyoruz.
      const call = peer.call(targetId, null); 
      currentCall = call; // Mevcut Ã§aÄŸrÄ±yÄ± sakla

      // !!! Ã–NEMLÄ° KONTROL !!!
      // peer.call() normalde bir MediaConnection nesnesi dÃ¶ndÃ¼rmelidir.
      // EÄŸer 'undefined' dÃ¶nerse, bu PeerJS'in iÃ§sel bir hatasÄ± veya ciddi bir baÄŸlantÄ± sorunudur.
      if (!call) {
        console.error("KRÄ°TÄ°K HATA: peer.call() 'undefined' dÃ¶ndÃ¼rdÃ¼. Bu, PeerJS'in dÃ¼zgÃ¼n Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± gÃ¶sterir. Peer nesnesi:", peer);
        alert("YayÄ±ncÄ±ya Ã§aÄŸrÄ± baÅŸlatÄ±lamadÄ± (call nesnesi oluÅŸturulamadÄ±).\nKonsolu kontrol edin. PeerJS baÄŸlantÄ±nÄ±zda veya sunucuda bir sorun olabilir.");
        currentCall = null;
        return;
      }

      console.log("Ã‡aÄŸrÄ± nesnesi oluÅŸturuldu. YayÄ±ncÄ±nÄ±n yanÄ±tÄ± ve medya akÄ±ÅŸÄ± bekleniyor...", call);
      watchButton.textContent = "BaÄŸlantÄ±yÄ± Kes";
      startButton.disabled = true; // Ä°zleme sÄ±rasÄ±nda yayÄ±n baÅŸlatmayÄ± engelle
      targetIdInput.disabled = true;


      // YayÄ±ncÄ±dan medya akÄ±ÅŸÄ± (stream) geldiÄŸinde tetiklenir.
      call.on('stream', remoteStream => {
        console.log('Uzak yayÄ±n (stream) alÄ±ndÄ±:', remoteStream);
        videoElement.srcObject = remoteStream;
        videoElement.muted = false; // Ä°zleyici aktif olarak izlemeye baÅŸladÄ±ÄŸÄ± iÃ§in sesi aÃ§abiliriz (tarayÄ±cÄ± politikalarÄ±na baÄŸlÄ±)
        videoElement.play().catch(e => console.warn("Uzak video oynatma hatasÄ± (otomatik oynatma engellenmiÅŸ olabilir):", e));
        alert(`'${targetId}' ID'li yayÄ±ncÄ±nÄ±n yayÄ±nÄ±na baÄŸlanÄ±ldÄ±!`);
      });

      // Ã‡aÄŸrÄ± sÄ±rasÄ±nda bir hata oluÅŸursa tetiklenir.
      call.on('error', err => {
        console.error(`Ã‡aÄŸrÄ± sÄ±rasÄ±nda hata (${call.peer}):`, err);
        alert(`Ã‡aÄŸrÄ± hatasÄ±: ${err.message}\n\nYayÄ±ncÄ± ID'sinin doÄŸru olduÄŸundan ve yayÄ±ncÄ±nÄ±n yayÄ±nda olduÄŸundan emin olun.`);
        resetWatchUI();
      });

      // Ã‡aÄŸrÄ± sonlandÄ±ÄŸÄ±nda (yayÄ±ncÄ± kapatÄ±rsa veya baÄŸlantÄ± koparsa) tetiklenir.
      call.on('close', () => {
        console.log(`Ã‡aÄŸrÄ± (${call.peer} ile) sonlandÄ±/kapatÄ±ldÄ±.`);
        alert('YayÄ±n baÄŸlantÄ±sÄ± kapandÄ±.');
        resetWatchUI();
      });
    };

    function resetWatchUI() {
        videoElement.srcObject = null;
        if (currentCall) {
            currentCall.removeAllListeners(); // Bellek sÄ±zÄ±ntÄ±larÄ±nÄ± Ã¶nlemek iÃ§in tÃ¼m listener'larÄ± kaldÄ±r
            currentCall = null;
        }
        watchButton.textContent = "ğŸ“º Ä°zle";
        targetIdInput.disabled = false;
        // EÄŸer kendi yayÄ±nÄ±mÄ±zÄ± yapmÄ±yorsak yayÄ±n baÅŸlatma butonunu aktif et
        if (!localStream && peer && !peer.disconnected && !peer.destroyed) {
            startButton.disabled = false;
        }
    }

    // Sayfa yÃ¼klendiÄŸinde PeerJS'i baÅŸlat
    initializePeer();

  </script>
</body>
</html>
