<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>PeerJS ile Ekran YayÄ±nÄ±</title>
  <style>
    body { background: #000; color: #fff; text-align: center; font-family: sans-serif; margin: 0; padding: 20px; }
    video { width: 90%; max-width: 800px; margin-top: 20px; border: 2px solid lime; background-color: #222; }
    button, input { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: #fff; font-size: 16px; }
    button:hover:not(:disabled) { background-color: #444; cursor: pointer;}
    button:disabled { background-color: #2a2a2a; color: #666; cursor: not-allowed;}
    input { background-color: #111; border-color: #444; }
    #my-id-container { margin-bottom: 15px; font-size: 18px; }
    #controls { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>PeerJS ile Ekran YayÄ±nÄ±</h1>
  
  <div id="my-id-container">
    Benim ID'm: <span id="my-id" style="font-weight: bold; color: lime;">YÃ¼kleniyor...</span>
  </div>

  <div id="controls">
    <button id="start">ğŸ–¥ï¸ YayÄ±nÄ± BaÅŸlat</button>
    <input type="text" id="target-id" placeholder="YayÄ±ncÄ± ID'sini girin">
    <button id="watch">ğŸ“º Ä°zle</button>
  </div>

  <video id="video" autoplay playsinline controls muted></video>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const videoElement = document.getElementById('video');
    const myIdSpan = document.getElementById('my-id');
    const startButton = document.getElementById('start');
    const watchButton = document.getElementById('watch');
    const targetIdInput = document.getElementById('target-id');

    let localStream = null;
    let peer = null;
    let currentCall = null;

    const peerJsConfig = {
      host: 'peercik.onrender.com', // Render sunucu adresiniz
      port: 443,
      path: '/myapp',
      secure: true,
      // debug: 3 // Gerekirse hata ayÄ±klama seviyesini artÄ±rÄ±n
    };

    function initializePeer() {
      console.log("PeerJS baÅŸlatÄ±lÄ±yor...");
      if (peer) {
        console.log("Mevcut Peer nesnesi temizleniyor.");
        peer.destroy(); // Ã–nceki baÄŸlantÄ±yÄ± temizle (varsa)
      }
      peer = new Peer(undefined, peerJsConfig);

      peer.on('open', id => {
        myIdSpan.textContent = id;
        console.log('PeerJS baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±. Benim ID:', id, 'Peer.open:', peer.open);
        enableControls();
      });

      peer.on('call', incomingCall => {
        console.log('Gelen Ã§aÄŸrÄ±:', incomingCall.peer);
        if (localStream) {
          console.log(`${incomingCall.peer} adlÄ± kullanÄ±cÄ±ya yayÄ±nla cevap veriliyor.`);
          incomingCall.answer(localStream);
          
          incomingCall.on('stream', remoteStream_broadcaster => {
             // YayÄ±ncÄ± olarak, izleyiciden bir stream beklemiyoruz, ama olay burada.
             console.log("YayÄ±ncÄ±: Ä°zleyiciden 'stream' olayÄ± geldi (beklenmedik, izleyici stream gÃ¶ndermemeli):", remoteStream_broadcaster);
          });
          incomingCall.on('close', () => {
            console.log(`Ä°zleyici ${incomingCall.peer} baÄŸlantÄ±sÄ± kapandÄ± (yayÄ±ncÄ± tarafÄ±).`);
          });
          incomingCall.on('error', err => {
            console.error(`Gelen Ã§aÄŸrÄ±da (${incomingCall.peer}) hata (yayÄ±ncÄ± tarafÄ±):`, err);
          });
        } else {
          console.warn('Gelen Ã§aÄŸrÄ± var ancak yerel yayÄ±n (localStream) mevcut deÄŸil. Ã‡aÄŸrÄ± yoksayÄ±lÄ±yor.');
          // incomingCall.close(); // Ä°steÄŸe baÄŸlÄ± olarak Ã§aÄŸrÄ±yÄ± reddedebilirsiniz
        }
      });

      peer.on('error', err => {
        console.error('PeerJS Genel HatasÄ±:', err, 'Peer.open:', peer ? peer.open : 'peer yok', 'Peer.disconnected:', peer ? peer.disconnected : 'peer yok');
        myIdSpan.textContent = "BaÄŸlantÄ± HatasÄ±!";
        if (!alert(`PeerJS BaÄŸlantÄ± HatasÄ±: ${err.message}\n\nLÃ¼tfen sayfayÄ± yenileyin veya PeerJS sunucu ayarlarÄ±nÄ± kontrol edin.`)) {
            // Alert kapatÄ±ldÄ±ktan sonra butonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
            disableControlsOnError();
        }
        
        if (err.type === 'peer-unavailable') {
             alert('Aranan kullanÄ±cÄ± IDsi bulunamadÄ± veya Ã§evrimdÄ±ÅŸÄ±.');
        } else if (err.type === 'network') {
             alert('AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± veya PeerJS sunucusuna eriÅŸimi kontrol edin.');
        } else if (err.type === 'server-error') {
             alert('PeerJS sunucusunda bir hata oluÅŸtu.');
        } else if (err.type === 'socket-error' && err.message === 'Socket closed') {
            myIdSpan.textContent = "Sunucu baÄŸlantÄ±sÄ± kapandÄ±.";
        }
        // Hata sonrasÄ± kontrolleri devre dÄ±ÅŸÄ± bÄ±rak
        disableControlsOnError();
      });

      peer.on('disconnected', () => {
        console.warn('PeerJS sunucusuyla baÄŸlantÄ± kesildi. Yeniden baÄŸlanmaya Ã§alÄ±ÅŸÄ±lÄ±yor... Peer.open:', peer.open);
        myIdSpan.textContent = "BaÄŸlantÄ± kesildi...";
        // BaÄŸlantÄ± kesildiÄŸinde kontrolleri devre dÄ±ÅŸÄ± bÄ±rakmak iyi bir pratiktir.
        // PeerJS otomatik yeniden baÄŸlanmayÄ± dener, 'open' event'i tekrar tetiklenirse kontroller aÃ§Ä±lÄ±r.
        disableControlsOnDisconnect();
      });

      peer.on('close', () => {
        console.log('Peer baÄŸlantÄ±sÄ± tamamen kapandÄ± (destroy edildi). Peer.open:', peer.open);
        myIdSpan.textContent = "KapalÄ±";
        disableControlsOnError();
      });
    }

    function enableControls() {
        startButton.disabled = false;
        watchButton.disabled = false;
        targetIdInput.disabled = false;
        console.log("Kontroller etkinleÅŸtirildi.");
    }

    function disableControlsOnDisconnect() {
        console.log("BaÄŸlantÄ± kesildi, kontroller geÃ§ici olarak devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±yor.");
        startButton.disabled = true;
        watchButton.disabled = true;
        targetIdInput.disabled = true;
    }

    function disableControlsOnError() {
        console.log("Hata nedeniyle kontroller kalÄ±cÄ± olarak devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±yor.");
        startButton.disabled = true;
        watchButton.disabled = true;
        targetIdInput.disabled = true;
    }
    
    // BaÅŸlangÄ±Ã§ta butonlar PeerJS baÄŸlanana kadar devre dÄ±ÅŸÄ± bÄ±rakÄ±lÄ±r.
    startButton.disabled = true; 
    watchButton.disabled = true;
    targetIdInput.disabled = true;

    startButton.onclick = async () => {
      if (localStream) {
        stopBroadcast();
        return;
      }

      try {
        console.log('Ekran yayÄ±nÄ± baÅŸlatÄ±lÄ±yor...');
        localStream = await navigator.mediaDevices.getDisplayMedia({
          video: { width: { ideal: 1920, max: 1920 }, height: { ideal: 1080, max: 1080 }, frameRate: { ideal: 30, max: 60 } },
          audio: { echoCancellation: true, noiseSuppression: true, sampleRate: 44100 }
        });
        
        videoElement.srcObject = localStream;
        videoElement.play().catch(e => console.warn("Yerel video oynatma hatasÄ±:", e));
        console.log('Ekran yakalama baÅŸarÄ±lÄ±. YayÄ±n baÅŸladÄ±.');
        
        startButton.textContent = "YayÄ±nÄ± Durdur";
        watchButton.disabled = true; 
        targetIdInput.disabled = true;

        localStream.getVideoTracks()[0].onended = () => {
          console.log("Ekran paylaÅŸÄ±mÄ± kullanÄ±cÄ± tarafÄ±ndan veya bir nedenle sonlandÄ±rÄ±ldÄ±.");
          stopBroadcast();
        };

      } catch (err) {
        console.error('Ekran yakalama veya yayÄ±n baÅŸlatma hatasÄ±:', err);
        alert(`Ekran yakalama baÅŸlatÄ±lamadÄ±: ${err.name} - ${err.message}`);
        localStream = null; 
      }
    };

    function stopBroadcast() {
        console.log("YayÄ±n durduruluyor...");
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        videoElement.srcObject = null;
        
        startButton.textContent = "ğŸ–¥ï¸ YayÄ±nÄ± BaÅŸlat";
        // PeerJS hala baÄŸlÄ± ve 'open' ise izleme kontrollerini tekrar aktif et
        if (peer && peer.open && !peer.destroyed) {
            watchButton.disabled = false;
            targetIdInput.disabled = false;
        } else if (peer && (!peer.open || peer.destroyed)) {
            // EÄŸer peer baÄŸlantÄ±sÄ± saÄŸlÄ±klÄ± deÄŸilse, kontrolleri devre dÄ±ÅŸÄ± tut
            disableControlsOnDisconnect(); // veya disableControlsOnError()
        }
        console.log("YayÄ±n durduruldu.");
    }

    watchButton.onclick = () => {
      if (currentCall) {
        console.log("Mevcut yayÄ±n sonlandÄ±rÄ±lÄ±yor...");
        currentCall.close();
        // resetWatchUI(), 'close' handler'Ä±nda Ã§aÄŸrÄ±lacak.
        return;
      }

      const targetId = targetIdInput.value.trim();
      if (!targetId) {
        alert("LÃ¼tfen bir YayÄ±ncÄ± ID'si girin.");
        return;
      }

      console.log('Ä°zleme butonuna tÄ±klandÄ±. Mevcut Peer durumu:', {
          id: peer ? peer.id : 'Peer yok/null',
          disconnected: peer ? peer.disconnected : 'Peer yok/null',
          destroyed: peer ? peer.destroyed : 'Peer yok/null',
          open: peer ? peer.open : 'Peer yok/null' // peer.open Ã¶zelliÄŸini loglayÄ±n
      });

      if (!peer || peer.disconnected || peer.destroyed || (peer && !peer.open)) {
        alert("PeerJS baÄŸlantÄ±sÄ± aktif deÄŸil veya tam olarak kurulmamÄ±ÅŸ. LÃ¼tfen sayfayÄ± yenileyin veya baÄŸlantÄ±nÄ±n kurulmasÄ±nÄ± bekleyin.");
        console.error("Ä°zleme denemesi baÅŸarÄ±sÄ±z: PeerJS baÄŸlantÄ±sÄ± yok, kopuk veya 'open' deÄŸil. Peer nesnesi:", peer);
        return;
      }
      
      if (targetId === myIdSpan.textContent) {
        alert("Kendi yayÄ±nÄ±nÄ±zÄ± bu ÅŸekilde izleyemezsiniz. FarklÄ± bir tarayÄ±cÄ± veya cihaz kullanÄ±n.");
        return;
      }

      console.log(`'${targetId}' ID'li yayÄ±ncÄ±ya baÄŸlanÄ±lÄ±yor...`);
      
      console.log('peer.call Ã§aÄŸrÄ±lmadan hemen Ã¶nce. Peer.id:', peer.id, 'Peer.open:', peer.open, 'Peer.disconnected:', peer.disconnected, 'Peer.destroyed:', peer.destroyed);

      const call = peer.call(targetId, null); // Ä°zleyici olarak kendi stream'imizi gÃ¶ndermiyoruz (null)
      currentCall = call; 

      if (!call) {
        console.error("KRÄ°TÄ°K HATA: peer.call() 'undefined' dÃ¶ndÃ¼rdÃ¼. Bu, PeerJS'in dÃ¼zgÃ¼n Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± gÃ¶sterir. Peer nesnesi:", peer);
        alert("YayÄ±ncÄ±ya Ã§aÄŸrÄ± baÅŸlatÄ±lamadÄ± (call nesnesi oluÅŸturulamadÄ±).\nKonsolu kontrol edin. PeerJS baÄŸlantÄ±nÄ±zda veya sunucuda bir sorun olabilir.");
        currentCall = null; 
        // ArayÃ¼zÃ¼ sÄ±fÄ±rlayabiliriz veya butonlarÄ± ayarlayabiliriz.
        // resetWatchUI(); // Hata sonrasÄ± arayÃ¼zÃ¼ sÄ±fÄ±rlamak iÃ§in
        watchButton.textContent = "ğŸ“º Ä°zle";
        if (peer && peer.open && !peer.destroyed && !localStream) startButton.disabled = false; // EÄŸer yayÄ±n yapmÄ±yorsak ve peer saÄŸlamsa
        targetIdInput.disabled = false;
        return;
      }

      console.log("Ã‡aÄŸrÄ± nesnesi oluÅŸturuldu. YayÄ±ncÄ±nÄ±n yanÄ±tÄ± ve medya akÄ±ÅŸÄ± bekleniyor...", call);
      watchButton.textContent = "BaÄŸlantÄ±yÄ± Kes";
      startButton.disabled = true; 
      targetIdInput.disabled = true;

      call.on('stream', remoteStream => {
        console.log('Uzak yayÄ±n (stream) alÄ±ndÄ±:', remoteStream);
        videoElement.srcObject = remoteStream;
        videoElement.muted = false; 
        videoElement.play().catch(e => console.warn("Uzak video oynatma hatasÄ±:", e));
        alert(`'${targetId}' ID'li yayÄ±ncÄ±nÄ±n yayÄ±nÄ±na baÄŸlanÄ±ldÄ±!`);
      });

      call.on('error', err => {
        console.error(`Ã‡aÄŸrÄ± sÄ±rasÄ±nda hata (${call.peer}):`, err);
        alert(`Ã‡aÄŸrÄ± hatasÄ±: ${err.message}\n\nYayÄ±ncÄ± ID'sinin doÄŸru olduÄŸundan ve yayÄ±ncÄ±nÄ±n yayÄ±nda olduÄŸundan emin olun.`);
        resetWatchUI();
      });

      call.on('close', () => {
        console.log(`Ã‡aÄŸrÄ± (${call.peer} ile) sonlandÄ±/kapatÄ±ldÄ± (izleyici tarafÄ±).`);
        // alert('YayÄ±n baÄŸlantÄ±sÄ± kapandÄ±.'); // KullanÄ±cÄ±yÄ± Ã§ok fazla alert ile yormamak iÃ§in bunu kapatabiliriz.
        console.log('YayÄ±n baÄŸlantÄ±sÄ± kapandÄ±.');
        resetWatchUI();
      });
    };

    function resetWatchUI() {
        console.log("resetWatchUI Ã§aÄŸrÄ±ldÄ±.");
        videoElement.srcObject = null;
        videoElement.muted = true; // Sesi tekrar kapat
        if (currentCall) {
            currentCall.removeAllListeners(); 
            currentCall = null;
        }
        watchButton.textContent = "ğŸ“º Ä°zle";
        targetIdInput.disabled = false;
        
        // EÄŸer kendi yayÄ±nÄ±mÄ±zÄ± yapmÄ±yorsak ve PeerJS baÄŸlantÄ±sÄ± saÄŸlamsa yayÄ±n baÅŸlatma butonunu aktif et
        if (!localStream && peer && peer.open && !peer.destroyed) {
            startButton.disabled = false;
        } else if (localStream) { // EÄŸer yayÄ±n yapÄ±yorsak, yayÄ±n baÅŸlatma butonu "YayÄ±nÄ± Durdur" olarak kalmalÄ± ve aktif olmalÄ±
             startButton.disabled = false;
        } else { // PeerJS baÄŸlantÄ±sÄ± saÄŸlÄ±klÄ± deÄŸilse veya yayÄ±n yapÄ±lÄ±yorsa, startButton devre dÄ±ÅŸÄ± kalsÄ±n.
            startButton.disabled = true;
        }
    }

    // Sayfa yÃ¼klendiÄŸinde PeerJS'i baÅŸlat
    initializePeer();

  </script>
</body>
</html>
